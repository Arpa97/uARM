#!/bin/bash

function usage(){
	PNAME=$(basename $0)
	echo -e "Usage\t$PNAME [-h] [-nc] [-nc] [target] -- [make options]"
	echo
	echo -e "\t$PNAME\t compiles all binaries"
	echo -e "\t$PNAME target\t compiles desired target"
	echo -e "\t$PNAME -nc\t avoid ./configure execution before compilation"
	echo -e "\t$PNAME -ca\t run \`make cleanall\` before compiling each target (sometimes needed to fix compilation errors)"
	echo -e "\t$PNAME -h\t shows this help"
	echo
	echo -e "\tmake options are used by make when compiling each target"
	echo 
	echo -e "\tPossible targets are:"
	echo -e "\t\tmkdev"
	echo -e "\t\tuarm"
}

function compile(){
	echo "Compiling $1...."
	echo
	XN="$1"
	BD="$1"-build
	MD=`pwd`
	shift
	mkdir -p "$BD"
	pushd "$BD" > /dev/null
		$QMCOMP "$MD/$1"
		shift
		if $CLEANALL; then
			echo "cleaning target $XN.."
			make clean > /dev/null 2>&1
			make cleanall > /dev/null 2>&1
		fi
		make $*
	popd > /dev/null
	cp "$BD/$XN" .
}

SET=""
CONFIGURE=true
CLEANALL=false

if test $# -gt 0; then
	SCAN=false
	while test -n "$1"; do
		case "$1" in
			"uarm")
				SET="u:$SET"
				;;
			"mkdev")
				SET="m:$SET"
				;;
			"-h")
				usage
				exit 0
				;;
			"--")
				SCAN=true
				;;
			"-nc")
				CONFIGURE=false
				;;
			"-ca")
				CLEANALL=true
				;;
			*)
				echo "unknown target: $1"
				usage
				exit 1
				;;
		esac
		shift
		if $SCAN; then
			break
		fi
	done
fi

if test -z "$SET"; then
	SET="u:m:e"
fi

qtchooser >> /dev/null 2> /dev/null
QMAKERET=`echo $?`

if [ $QMAKERET -ne 127 ]; then
	VERSION=0
	for v in `qtchooser -l`; do
		if [[ $v == 5* ]]; then
			VERSION=`echo $v`
			break
		fi
	done
	if [ "$VERSION" == 0 ]; then
		echo "!!!!!!!! it seems you don't have qt5 installed, aborting compilation !!!!!!!!"
		exit 1
	fi
	QMCOMP="qtchooser -run-tool=qmake -qt=$VERSION"
	echo "compiler command: \"$QMCOMP $*\""
	echo
else
	echo "!!!!!!!! it seems you don't have qt5 installed, aborting compilation !!!!!!!!"
	exit 1
fi

if $CONFIGURE; then
	./configure
fi

if [[ "$SET" = *"u"* ]]; then
	compile "uarm" "qarm.pro" $*
fi

if [[ "$SET" = *"m"* ]]; then
	compile "uarm-mkdev" "mkdev.pro" $*
fi

