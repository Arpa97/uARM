\chapter{Processor}
The uARM machine runs on an emulated ARM7TDMI processor, with both ARM and Thumb ISAs implemented (Thumb is still a bit buggy right now), wich is able to perform each operation listed in \emph{ARM7TDMI Data Sheet} (a brief summary is shown below) and to accept painlessly binary programs compiled with the Gnu C Compiler for ARM7 architecture.

\section{Operating modes}
The processor can work in seven different modes:
\begin{itemize}
\item User mode (usr) - regular user process execution
\item System mode (sys) - typipcal privileged mode execution (e.g. kernel code execution)
\item Supervisor (srv) - protected mode kernel execution
\item Fast Interrupt (fiq) - protected mode for fast interrupt handling
\item Interrupt (irq) - protected mode for regular interrupt handling
\item Abort (abt) - protected mode for data/instruction abort exception handling
\item Undefined (und) - protected mode for undefined instruction exception handling
\end{itemize}

In each mode the processor can access a limited portion of all its registers, varying from 16 registers in User/System modes to 17 registers in each protected mode in ARM state (only protected modes have the 17th register, it automatically stores the previous value of the Program Status Register when entering an exception) plus the Current Program Status Register (CPRS), wich is shared by all modes.

The lower 8 registers in addition to the Program Counter (R15) are common to each "window" of visible registers, each protected mode has its dedicated upper 2 registers and Fast Interrupt mode has all the upper 7 unique registers to allow for a fast context switch, while System and User mode share the full set of 16 general puprose registers.

\input{tex/tables/ARM_reg.tex}

Even if the base 16 registers are defined as general purpose registers, there are some conventions adopted by the compiler in their use. The following list shows the full set of processor register visible in each mode with their conventional meaning:

\begin{itemize}
\item R0 (a1) - first function argument / integer result
\item R1 (a2) - second function argument
\item R2 (a3) - third function argument
\item R3 (a4) - fourth function argument
\item R4 (v1) - register variable
\item R5 (v2) - register variable
\item R6 (v3) - register variable
\item R7 (v4) - register variable
\item R8 (v5) - register variable
\item R9 (v6/rfp) - register variable / real frame pointer
\item R10 (sl) - stack limit
\item R11 (fp) - frame pointer / argument pointer
\item R12 (ip) - instruction pointer / temporary workspace
\item R13 (sp) - stack pointer
\item R14 (lr) - link register
\item R15 (pc) - program counter
\item CPSR - current program status register
\item SPSR\_\emph{mode} - saved program status register
\end{itemize}

When the processor is in Thumb state the register window is halved, showing 12 registers in User/System mode and 13 registers in protected modes (the last register is the same dedicated SPSR register as in ARM state) in addition to the Current Program Status Register, common to all modes. 

Only the first 8 registers (R0 $\rightarrow$ R7) are general purpose, the higher 3 are specialized registers that act as Stack Pointer, Link Return and Program Counter. Each protected mode has its own banked instance of Stack Pointer and Link Return in addition to Saved Program Status Register to allow for faster exception handling. 

\input{tex/tables/Thumb_reg.tex}

\subsection{Execution Control}

\subsubsection{Program Status Register}

The CPSR (and SPSR if active mode has one) is always accessible in ARM state via the special instructions MSR (move register to PRS) and MRS (move PRS to register). This register shows arithmetical instructions' additional results and allows to switch states/modes and interrupt handling. Its structure is shown below:

\vspace{5px}
\input{tex/tables/CPSR.tex}

The first 5 bits of CPSR are used to set processor execution mode, the possible values are:
\\

\begin{tabular}{r|l}
\texttt{0x10} & User Mode \\
\texttt{0x11} & Fast Interrupt Mode \\
\texttt{0x12} & Interrupt Mode \\
\texttt{0x13} & Supervisor Mode \\
\texttt{0x17} & Abort Mode \\
\texttt{0x1B} & Undefined Mode \\
\texttt{0x1F} & System Mode \\
\end{tabular}
\\

\emph{User Mode} is the only unprivileged mode, this means that if processor is running in \emph{User Mode} it cannot access \emph{reserved memory regions} (see System Bus chapter) and it cannot modify CPSR control bits.

\emph{System Mode} is the execution mode reserved for regular Kernel code execution, all other modes are activated when exceptions are being handled.

\subsubsection{System Control Register}

System Coprocessor (CP15) holds the System control register (CP15.R1), wich controls Virtual Memory and thumb availability (plus some other hardware specific settings that are not implemented in current release):

\begin{itemize}
\item bit 0 : if set, the Memory Management Unit is enabled
\item bit 15 : if set, changes to T bit in CPSR are ignored
\end{itemize}

\section{Processor States}

The \emph{T} flag of the Program Status Register shows the state of the processor, when the bit is clear the processor operates in ARM state, otherwise it worsk in Thumb state. To switch between the two states a Branch and Exchange (BX) instruction is required.

The first difference between the two states is the register set that is accessible (see previous section), the other main difference is the Instruction Set used.

\subsection{ARM ISA}

The main Instruction Set is the ARM ISA, the processor starts execution in this state and switches to ARM state when entering excepton handling sections.

ARM instructions are 32 bits long and must be word-aligned. The table below shows a brief summary of the instruction set. (For a much detailed description of each instruction refer to \emph{ARM7TMI Data Sheet} and \emph{ARM7TMI Technical Reference Manual})

\input{tex/tables/ARM_isa.tex}

\subsection{Thumb ISA}

Thumb instruction set is a simpler (smaller) instruction set composed of 16-bit, halfword aligned instructions, wich offer less refined functionalities but less memory usage.

Thumb instructions can be seen as "shortcuts" to execute ARM code, as the performed operations are the same but this ISA offers less options for each instruction.

The following table summarizes Thumb instructions. (For a much detailed description of each instruction refer to \emph{ARM7TMI Data Sheet} and \emph{ARM7TMI Technical Reference Manual})

\input{tex/tables/Thumb_isa.tex}

\section{Exception Handling}

When an exception is raised (e.g. a read instruction is performed on a forbidden bus address), the processor automatically enter a special routine to solve the problem. 

There are seven different exceptions handled by the processor, each of them has a specific bus address to wich the execution jumps on exception handling (see Bus chapter for further details).

When enetring an exception handler, the processor stores a return address in the Link Return register and the Current Program Status Register in the SPSR register of the handler's Processor mode.

\subsubsection{Reset Exception}
This exception is automatically raised each time the machine is started. 

This exception is handled in Supervisor mode with all interrupts disabled, Link Return and SPSR registers have unpredictable values and execution starts from bus address \texttt{0x00000000}.

\subsubsection{Undefined Instruction Exception}
If a Coprocessor instruction cannot be executed from any Coprocessor or if an UNDEFINED instruction is executed, this exception is raised. 

Processor mode is set to Undefined, normal interrupts are disabled and Link Return register points to the instruction right after the one that caused the Undefined Exception.

\subsubsection{Software Interrupt Exception}
This exception is caused by a SWI instruction and is meant to provide a neat way to implement System Calls. 

When handling Software Interrupt Exceptions, the processor switches to Supervisor mode with normal interrupts disabled and the Link Return register points to the instruction after the SWI that caused the excetpion.

\subsubsection{Data Abort Exception}
If a the processor tries to access memory address that is not valid or available, this exception is raised.

When handling Data Aborts, the processor switches to Abort mode with normal interrupts disabled and Link Return register is set to the address of the instruction after the one that caused the Abort plus 8.


\subsubsection{Prefetch Abort Exception}
If the processor tries to execute an instruction that generated a data abort while being fetched, this exception is raised.

When handling Prefetch Aborts, the processor enters Abort mode with normal interrupts disabled and Link Return register points to the address of the instruction after the one that caused the exception plus 4.

\subsubsection{Interrupt Request Exception}
When a connected Device requires the processor's attention, it fires an Interrupt Request.

When handling Interrupt Requests, the processor enters Interrupt mode with normal interrupts disabled and Link Return register is set to the address of the next instruction to be executed plus 4.

\subsubsection{Fast Interrupt Request Exception}
Fast Interrupts have higher priority than norma Interrupts, also, system Interval Timer is connected to this line of interrupts. When the Timer changes its value from \texttt{0x00000000} to \texttt{0xFFFFFFFF}, a Fast Interrupt is requested.

When handling Fast Interrupt Requests, the processor enters Fast Interrupt mode with all interrupts disabled and Link Return register points to the address of the next instruction to be executed plus 4.

\section{System Coprocessor}

CP15 provides access to a total of three 64-bit and one 32-bit registers wich give additional informations and functionalities to regular processor operations:

\subsubsection{R0 (IDC) - ID Codes}
Register 0 is a read-only register that contains system implementation informations such as \emph{Processor ID}, \emph{TLB type}, \emph{Memory Protection Unit type}, \emph{Cache type} and \emph{Tightly Coupled Memory type}.

\subsubsection{R1 (SCB) - System Control Bits}
Register 1.SCB is the System Control Register, from wich MMU and Processor State modifications can be enabled/disabled.

See \emph{Execution Control} section for further details.

\subsubsection{R1 (CCB) - Coprocessors Access Register}
Register 1.CCB shows wich coprocessors are available. Values can be written to this register to enable/disable available coprocessors a part from CP15.

\input{tex/tables/CP15_CCB.tex}

\subsubsection{R2 - Page Table Entry}
Register 2 is a 64-bit register wich contains the actual loaded Page Table Entry if MMU is enabled. Its structure is the same as a stored PTE (see \emph{Memory Interface.Virtual Addressing Mode} for structure details).

\subsubsection{R15 (Cause) - Exception Cause}
Register 15.Cause contains the last exception cause, it can be read or written by processor.

Memory Access exception causes are:
\\
\\
\begin{tabular}{ll}
Memory Error & = \texttt{1}\\
Bus Error & = \texttt{2}\\
Address Error & = \texttt{3}\\
Segment Error & = \texttt{4}\\
Page Error & = \texttt{5}\\
\end{tabular}

\subsubsection{R15 (IPC) - Interrupt Cause}
Register 15.IPC shows on which lines interrupts are pending, when interrupts have been handled the value of this register is updated.
