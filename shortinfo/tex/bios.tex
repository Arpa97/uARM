\chapter{BIOS \& System Library}

\section{BIOS}

\subsection{Bootstrap Function}

The bootstrap program bundled with uarm installation has the function to initialize hardware facilities and start execution.

The operation it performs are:

\begin{enumerate}
\item populate Exception Vector with Branch instructions to basic exception handling routines
\item set default Exception States Vector entries with \texttt{Branch to PANIC} instructions
\item retrieve entry point from kernel binary file
\item set execution mode to System mode with ARM ISA and all interrupts enabled
\item set exit point and ramtop value
\item clear all used scratch registers
\item jump to entry point
\end{enumerate}

\subsection{Low Level Services}

Low level services are requested by issuing a SWI instruction with the right parameter:

\subsubsection{Halt}

By executing \texttt{SWI \#1}, the BIOS will print "\texttt{SYSTEM HALTED.}" on Terminal 0 and shut down the virtual machine.

\subsubsection{Panic}

By executing \texttt{SWI \#2}, the BIOS will print "\texttt{KERNEL PANIC.}" on Terminal 0 and enter an infinite loop.

\subsubsection{LDST}

A \texttt{SWI \#3} instruction will begin the loading of the processor state stored at the address specified by \emph{a1} register to actual processor's registers, checking destination mode and setting only the right processor's registers window.

\subsubsection{Wait}

By executing \texttt{SWI \#4}, the BIOS will put the machine in IDLE state waiting for an interrupt to wake the system up.

\subsubsection{System Calls / Breakpoints}

If a \texttt{SWI \#8} or \texttt{SWI \#9} instruction is executed, the syscall handler passes up the call, setting the right cause in CP15 Cause register.

\section{System Library}

System library is provided by \emph{libuarm}, it offers a small but increasing set of methods to access low level functionalities.

\subsubsection{tprint(char *s)}

Print a '\textbackslash0' terminated array of chars to Terminal 0.

This function uses busy waiting to wait for the device to be ready.

\subsubsection{HALT()}

Run BIOS Halt function.

\subsubsection{PANIC()}

Run BIOS Panic function.

\subsubsection{WAIT()}

Run BIOS Wait function.

\subsubsection{LDST(void *addr)}

Calls the BIOS function that loads the entire processor state from state\_t stored at \emph{addr} address.

\subsubsection{STST(void *addr)}

Stores the actual processor state in state\_t structure pointed by \emph{addr}.

\subsubsection{SYSCALL(unsigned int sysNum, unsigned int arg1, unsigned int arg2, unsigned int arg3)}

Generates a software exception leading to kernel defined Syscall handler.

\subsubsection{BREAK(unsigned int arg0, unsigned int arg1, unsigned int arg2, unsigned int arg3)}

Generates a software exception leading to kernel defined Breakpoint handler.

\subsubsection{getSTATUS() / setSTATUS()}

Manipulate Current Program Status Register.

\subsubsection{getCAUSE() / setCAUSE()}

Manipulate Exception/Interrupt Cause register.

\subsubsection{getTIMER() / setTIMER()}

Manipulate Interval Timer.

\subsubsection{getTODHI() / getTODLO()}

Returns the upper/lower part of Time of Day 64-bit register.

\subsubsection{getCONTROL() / setCONTROL()}

Manipulate System Control Register.

\subsubsection{getTLB\_Index() / setTLB\_Index(unsigned int index)}

Manipulate TLB Index register.

\subsubsection{getTLB\_Random()}

Returns TLB Random register.

\subsubsection{getEntryHi() / setEntryHi(unsigned int hi) / getEntryLo() / setEntryLo(unsigned int lo)}

Manipulate TLB Entry Hi and Entry Low registers.

\subsubsection{getBadVAddr()}

Returns BadVAddr register, which contains the faulting address in case of Page Fault Exceptions.

\subsubsection{TLBWR()}

Write the contents of EntryHi and EntryLo to the TLB slot indicated by TLB Random register value.

\subsubsection{TLBWI()}

Write the contents of EntryHi and EntryLo to the TLB slot indicated by TLB Index register value.

\subsubsection{TLBR()}

Read the contents of TLB slot indicated by TLB Index register value in EntryHi and EntryLo registers.

\subsubsection{TLBP()}

Scan the TLB searching for a pair that matches VPN in EntryHi and ASID in EntryHi or that has G flag set in EntryLo and is Valid, if a match is found, its index in the TLB cache is stored as TLB Index register value, otherwise that register will have 31st bit set to 1.

\subsubsection{TLBCLR()}

Set all TLB contents to 0.
